<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Home Task Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f4f6f8;padding:15px}
.card{background:#fff;padding:20px;border-radius:10px;margin-bottom:15px}
button{padding:10px 15px;border:none;border-radius:6px;background:#4caf50;color:#fff}
.hidden{display:none}
.header{display:flex;justify-content:space-between;background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;font-weight:bold}
.warning{background:#fff3cd;padding:10px;border-radius:6px;margin-top:8px;font-size:13px}
</style>
</head>

<body>

<div id="loginCard" class="card">
<h3>Login</h3>
<input id="uid" placeholder="User ID"><br><br>
<input id="pwd" type="password" placeholder="Password"><br><br>
<button onclick="login()">Login</button>
<p id="err" style="color:red"></p>
</div>

<div id="dash" class="hidden">

<div class="header">
<div id="profileName"></div>
<div>Fine: ‚Çπ<span id="fineBox">0</span></div>
</div>

<div class="card">
<h3>üçΩ Kitchen</h3>
<div id="kitchenBox"></div>
<button id="kitchenBtn" class="hidden">Mark Completed</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
import { getDatabase, ref, get, set, update, onValue } 
from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

const firebaseConfig = {
apiKey: "AIzaSyClGRnMuCTZTIMXaA41bUEezlFUsfnEr9A",
authDomain: "mmdb-1794d.firebaseapp.com",
databaseURL: "https://mmdb-1794d-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId: "mmdb-1794d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const people = ["Vedant","Pratik","Omkar","Yash"];

/* CHANGE START DATE IF NEEDED */
const START_DATE = new Date("2025-02-01T18:00:00");

let currentUser=null;

window.login = async function(){
const id = uid.value.toLowerCase();
const snap = await get(ref(db,"users/"+id));
if(!snap.exists() || snap.val().pass !== pwd.value){
err.innerText="Invalid login";
return;
}
currentUser=id;
profileName.innerText=id.charAt(0).toUpperCase()+id.slice(1);
loginCard.classList.add("hidden");
dash.classList.remove("hidden");

onValue(ref(db,"users/"+id+"/fine"),s=>{
fineBox.innerText=s.val()||0;
});

handleKitchen();
};

/* ================= KITCHEN LOGIC ================= */

function getCycleNumber(){
const now = new Date();
return Math.floor((now - START_DATE)/(1000*60*60*24));
}

function handleKitchen(){

  const START_DATE = new Date("2025-02-01T18:00:00");

  function getCycleNumber(){
    const now = new Date();
    return Math.floor((now - START_DATE)/(1000*60*60*24));
  }

  function getCycleStart(){
    const cycle = getCycleNumber();
    return new Date(START_DATE.getTime() + cycle*24*60*60*1000);
  }

  onValue(ref(db,"kitchen"), async snap=>{

    const data = snap.val()||{};
    const lastCompletedCycle = data.lastCompletedCycle ?? -1;
    const fineCycle = data.fineCycle ?? -1;

    const now = new Date();
    const cycle = getCycleNumber();
    const cycleStart = getCycleStart();

    const assigned = people[cycle % people.length];
    const nextPerson = people[(cycle+1)%people.length];

    const deadline12 = new Date(cycleStart.getTime() + 18*60*60*1000); // +18h
    const hardShift6 = new Date(cycleStart.getTime() + 24*60*60*1000); // +24h

    /* -------- FINE AT 12 PM -------- */
    if(now >= deadline12 && fineCycle !== cycle && lastCompletedCycle !== cycle){

      await update(ref(db,"kitchen"),{
        fineCycle:cycle
      });

      const fineRef = ref(db,"users/"+assigned.toLowerCase()+"/fine");
      const f = await get(fineRef);
      await set(fineRef,(f.val()||0)+50);
    }

    /* -------- HARD SHIFT AT 6 PM -------- */
    if(now >= hardShift6){
      // automatically next cycle handled by cycle calc
    }

    /* -------- DISPLAY LOGIC -------- */

    if(lastCompletedCycle === cycle){

      // Show DONE until next 12 PM
      if(now < deadline12){

        kitchenBox.innerHTML =
          `<b>${assigned}</b> : DONE ‚úÖ<br>
           Next : <b>${nextPerson}</b>`;

      } else {

        kitchenBox.innerHTML =
          `Assigned : <b>${nextPerson}</b>`;
      }

      kitchenBtn.style.display="none";

    } else {

      kitchenBox.innerHTML =
        `Assigned : <b>${assigned}</b>
         <div class="warning">
         Task starts 6 PM<br>
         Fine at 12 PM<br>
         Hard shift at 6 PM
         </div>`;

      if(currentUser === assigned.toLowerCase() && now >= cycleStart){
        kitchenBtn.style.display="block";
      } else {
        kitchenBtn.style.display="none";
      }
    }

  });

  /* -------- MARK DONE -------- */
  kitchenBtn.onclick = async ()=>{

    const cycle = getCycleNumber();

    await update(ref(db,"kitchen"),{
      lastCompletedCycle:cycle
    });

    await push(ref(db,"taskLog"),{
      user:profileName.innerText,
      task:"Kitchen",
      date:new Date().toLocaleDateString(),
      time:new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})
    });
  };
}
/* -------- HARD SHIFT -------- */
if(now >= hardShift6){
return; // next cycle auto handled by cycle calc
}

/* -------- FINE CHECK -------- */
if(now >= deadline12 && fineCycle !== cycle && lastCompletedCycle !== cycle){
await update(ref(db,"kitchen"),{
fineCycle:cycle
});
const fineRef = ref(db,"users/"+assigned.toLowerCase()+"/fine");
const f = await get(fineRef);
await set(fineRef,(f.val()||0)+50);
}

/* -------- DISPLAY -------- */

if(lastCompletedCycle === cycle){

kitchenBox.innerHTML =
`<b>${assigned}</b> : DONE ‚úÖ<br>
Next : <b>${people[(cycle+1)%people.length]}</b>`;

kitchenBtn.classList.add("hidden");

}else{

kitchenBox.innerHTML =
`Assigned : <b>${assigned}</b>
<div class="warning">
Task started 6 PM<br>
Deadline 12 PM<br>
Hard shift 6 PM
</div>`;

if(currentUser === assigned.toLowerCase() && now >= cycleStart){
kitchenBtn.classList.remove("hidden");
}else{
kitchenBtn.classList.add("hidden");
}

}

});

/* MARK DONE */
kitchenBtn.onclick = async ()=>{
const cycle = getCycleNumber();
await update(ref(db,"kitchen"),{
lastCompletedCycle:cycle
});
};

}

</script>

</body>
</html>
